# Setup Guide for Super Smash Bros. Melee Archipelago

This game's developer has only tested on Windows, so please be sure to let her know how that goes on other environments in the future-game-design thread below!

## Requirements

The following are required in order to play _Super Smash Bros Melee_ in Archipelago:

- [Archipelago](https://github.com/ArchipelagoMW/Archipelago/releases)
- [Dolphin Emulator](https://dolphin-emu.org/download/). Please use the latest release when possible.
- A US _Super Smash Bros Melee_ Revision 2 ISO file
  - Copies from other regions of the world, and other revisions, aren't currently supported. 
  - The Japanese version might work considering that it's the same as the US version, but without the usa.ini file.

## APWorld Installation

1. Download the latest version of the [Melee AP World](https://github.com/hopesgit/Archipelago-Melee/releases/latest)
2. Double-click the downloaded `ssb_melee.apworld` file. The world will install itself in your `custom_worlds` directory.

## Setting Up Player Options YAML File

1. A sample YAML for __Super Smash Bros Melee__ is provided in the release files. If you want, you can use the `Generate Template Options` button in the Launcher to generate a template and fill that out.
2. Provide your .yaml file to the room host so they can include you in the multiworld.

## Generating a Multiworld

[Archipelago Setup Guide: Generating a game - On your local installation](https://archipelago.gg/tutorial/Archipelago/setup/en#on-your-local-installation)

## Hosting a Room

[Archipelago Setup Guide: Hosting an Archipelago Server](https://archipelago.gg/tutorial/Archipelago/setup/en#hosting-an-archipelago-server) to host a room.

### NOTE

When hosting with the Archipelago website, the website will *not* host patch files from imported custom worlds, such as __Super Smash Bros Melee__.
The person generating must manually distribute any `.apssbm` patch files to the corresponding players.

## Starting the Game and Connecting to a Room

You will need the following things:

1. Your `.apssbm` file - this will be in the output zip generated by whoever the host is. 
2. If you are hosting locally, check your output folder for the output zip file. If you are playing in a room hosted elsewhere, such as the AP website, make sure to get your `.apssbm` file from the room owner. 
3. Connection details - The room link to connect to, your username (the name field in your `.yaml`), and the room's password (if applicable).

Once you have those things, follow these steps to connect to the room:

1. In the Archipelago Launcher, click `Open Patch File`. Then select the `.apssbm` patch file.
   If you have not done so before, it will ask you what program you want to open it with.
2. If this is your first time, it will prompt you for an input iso. Select your _Metroid Prime_ GameCube ISO file.
3. The patching process occur in the background.
4. Once the output iso file appears in the same directory as your `.apssbm` file (it should be named `AP_XXXX.iso`), open it with Dolphin.
5. After the game is running, connect the Metroid Prime Client to the room by entering the server name and port number at the top and pressing `Connect`.
   For rooms hosted on the website, this will be `archipelago.gg:<port>`, where `<port>` is the port number.
   If a game is hosted from the `ArchipelagoServer.exe` (without `.exe` on Linux), this will default to `localhost:38281` but may be changed in the `host.yaml`.

### TIP

Try double-clicking your `.apssbm` patch file to automatically open your game for you,
 - Navigate to your `Archipelago` installation and edit the `host.yaml` file.
 - Scroll down to `ssb_melee_options` and either set `rom_start` to `true` if ISO files are already associated with Dolphin or set it to the path to your `Dolphin.exe`.
 - If `ssb_melee_options` isn't in the `host.yaml` yet, click your `.apssbm` patch file and then reopen the `host.yaml` and it should now be there.
 - Now when double-clicking the `.apssbm` patch file, it should open the client, patch, and launch Dolphin all at once!

### Generating and Patching Troubleshooting

- If you do not see the client in the Archipelago Launcher
  - Ensure you have your `ssb_melee.apworld` in the correct folder (The `custom_worlds` folder).
  - Check if you have residual files from previous versions in the lib/worlds folder - see the [APWorld Installation section](#apworld-installation)
- If you receive this error in a dialog box after opening the AP_XXXXX_Playername.apssbm file:
  > Can't Mount File
  > The disc image is corrupted.

  This is not an error related to the patcher - this is Windows File Explorer attempting to mount the GameCube ISO as a removable drive. It's likely that the patcher did successfully patch the game.
  See if the patched ISO exists (often named AP_XXXXX_Playername.iso). If it does, you can load it manually in Dolphin.

### Connection Troubleshooting

* I have the randomized game open in Dolphin, but the Melee client says it can't connect to it!
  *  Make Sure the ISO is randomized
    * The randomized ISO is NOT the copy that shows up in the base AP folder! That's just a copy that AP generates in order to use it in the future.
    * I plan to add an Archipelago-related nod on the title screen, eventually.
  * Ensure only one Instance of Dolphin is Running
    * Check Task Manager to see if there are multiple emulator instances running.
    * You can also just restart your computer to be sure.
  * You're using an unsupported version of Melee
    * Please (legally) acquire Rev 2 of the US Melee ISO. The European version is next on my dev list, but I can't guarantee that it will ever happen. 

* Disable Emulated Memory Size Override
  * In Dolphin, Config -> Advanced tab, **Uncheck** Enable Emulated Memory Size Override
  * Start the Super Smash Bros Melee Client and Dolphin in a Specific Order

* For some users, connecting to the AP server before letting the Super Smash Bros Melee client causes connection issues.
  
* Try starting programs in this order:

  1. Start the Super Smash Bros Melee client
  2. Start Dolphin and start the game (if it launches automatically, that's fine)
  3. Allow the game to create a save file on your memory card, if applicable
  4. Press Start to move to the Main Menu.
  5. Enter the AP server credentials into the Super Smash Bros Melee Client

* For Linux, use Dolphin FlatPak
  * Install Dolphin Emulator from [Flathub](https://flathub.org/apps/org.DolphinEmu.dolphin-emu)
  * Dolphin Memory Engine, as part of the Super Smash Bros Melee Client, can not access regular Dolphin's process but can access Flatpak's containerized Dolphin's process

## Feedback

In the official [Archipelago Discord](https://discord.com/invite/8Z65BR2) under the `future-game-design` channel, there is a [Super Smash Bros Melee thread](https://discord.com/channels/731205301247803413/1179050965802942474).
Feel free to ping `@kenna_puppers` with any bugs/thoughts/complaints/wishes/jokes you may have!
You can also submit an issue [on the Github page](https://github.com/hopesgit/Archipelago-Melee/issues).